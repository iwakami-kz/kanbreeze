# Requirements Document

## Introduction

本要件は、プロジェクト管理サービスにおける「レポート」機能を対象とする。利用者がプロジェクト状況や成果を「親しみ感のある落ち着いた明るい色合い」で直感的に把握し、意思決定・共有・アクションにつなげられることを目的とする。テンプレートからの迅速な作成、柔軟なデータ条件、見やすい可視化、配布・エクスポート、権限と監査までを包括する。

## Requirments

#### Epic 1
レポート作成フローとテンプレート

##### Requirment 1
**User Story:** ビジネスユーザーとして、用途に合ったレポートテンプレートを選びプレビューしたい。作成時間を短縮できるから。

###### Acceptance Criteria
1. テンプレートが選択された場合、システムはタイトル・想定用途・サンプルプレビューを同一画面で表示しなければならない。
2. テンプレートが不正なデータソースを含む場合、システムは選択をブロックし、欠落ソース名を明示しなければならない。
3. 常時、テンプレートは検索・タグ・用途（例：進捗、品質、負荷）で絞り込めなければならない。
4. テンプレートが更新された場合、既存レポートには影響を与えてはならない。

##### Requirment 2
**User Story:** 初めての利用者として、ガイド付き作成でレポートをゼロから作りたい。迷わず完成まで到達できるから。

###### Acceptance Criteria
1. 作成ウィザード開始時、システムは「データ選択→指標→可視化→レイアウト→確認」のステップを進行表示しなければならない。
2. 必須ステップが未完了のとき、次へ進む操作は許可してはならない。
3. 確認ステップで「想定表示件数・推定読込時間」を提示しなければならない。

##### Requirment 3
**User Story:** 作成途中のユーザーとして、下書きを自動保存・復元したい。作業の中断に強くしたいから。

###### Acceptance Criteria
1. 編集中である間、30秒ごとに差分を自動保存しなければならない。
2. ブラウザが異常終了した場合、再開時に最後の下書きを提示し、復元か破棄を選べなければならない。
3. 下書きは10件まで保持し、上限を超える場合は最終アクセスが最も古いものを削除しなければならない。

#### Epic 2
データ取得・スコープ・フィルタリング

##### Requirment 4
**User Story:** チームリーダーとして、対象プロジェクト・期間・ステータス等でデータを柔軟に絞りたい。分析の焦点を合わせるため。

###### Acceptance Criteria
1. 期間が選択された場合、システムは作成日・更新日・完了日の中から基準日を選ばせなければならない。
2. 常時、プロジェクト・コンポーネント・担当者・ステータス・ラベルでAND/OR条件を指定できなければならない。
3. 条件保存を実行した場合、名前付きフィルターとして再利用できなければならない。

##### Requirment 5
**User Story:** 管理者として、カスタムフィールド（例：優先度、影響度）を指標や集計に使いたい。現場の実情を反映するため。

###### Acceptance Criteria
1. カスタムフィールドが数値のとき、合計・平均・中央値・最大・最小の集計を選べなければならない。
2. カスタムフィールドが文字列/選択肢のとき、カテゴリ別件数と比率を表示しなければならない。
3. 対応外型のフィールドを指定した場合、利用不可の理由とサポート予定を表示しなければならない。

##### Requirment 6
**User Story:** 分析者として、スナップショット（過去時点）とリアルタイムの切替を行いたい。再現性と鮮度を両立するため。

###### Acceptance Criteria
1. スナップショットが選択された場合、取得日時とデータ件数を明示しなければならない。
2. リアルタイム選択時、更新タイムスタンプをヘッダーに常時表示しなければならない。
3. スナップショット比較を実行した場合、差分（増減・率）をハイライト表示しなければならない。

#### Epic 3
指標・可視化・KPI

##### Requirment 7
**User Story:** プロダクトオーナーとして、主要KPIカード（例：バーンダウン、ベロシティ、リードタイム中央値）を一目で確認したい。迅速に判断するため。

###### Acceptance Criteria
1. KPIカードは数値・前期間比・傾向アイコンを同一カード内で表示しなければならない。
2. 前期間が存在しない場合、比較表示を行ってはならない。
3. KPIの計算式はホバー時に説明テキストを表示しなければならない。

##### Requirment 8
**User Story:** スクラムマスターとして、チャート種類（棒、折れ線、面、円、累積フロー、バーンダウン）を適切に選びたい。現象に合う表現にするため。

###### Acceptance Criteria
1. チャート種類が変更された場合、系列・凡例・軸ラベルは文脈に合わせて自動再配置されなければならない。
2. データが疎である場合、線チャートは補間を行ってはならない。
3. 累積フローを選択した場合、状態遷移の順序が不整合ならレンダリングを拒否し理由を表示しなければならない。

##### Requirment 9
**User Story:** マネージャーとして、KPIに目標値としきい値を設定し、逸脱を即座に把握したい。早期に手を打つため。

###### Acceptance Criteria
1. 目標値が設定された場合、目標対比（達成率/差分）をカードとチャート上に同時表示しなければならない。
2. しきい値を超過/下回った場合、値と該当時点を強調表示し通知設定への導線を提示しなければならない。
3. 目標としきい値が矛盾する設定のとき、保存を許可してはならない。

#### Epic 4
レイアウト・テーマ・アクセシビリティ（「親しみ感のある落ち着いた明るい色合い」）

##### Requirment 10
**User Story:** レポート作成者として、セクションやカードをドラッグ&ドロップで配置したい。読みやすい順に構成するため。

###### Acceptance Criteria
1. 常時、グリッド（12列）にスナップし、最小幅と高さを満たさなければならない。
2. レイアウトが保存された場合、閲覧者には同一配置で表示されなければならない。
3. 印刷モードのとき、A4縦横で自動再配置し切れを発生させてはならない。

##### Requirment 11
**User Story:** デザイナーとして、親しみ感のある落ち着いた明るいテーマを適用したい。視認性とブランド一貫性を保つため。

###### Acceptance Criteria
1. テーマが有効なとき、色トークン（Primary/Secondary/Accent/Info/Success/Warning/Error/Surface/On-色）が全コンポーネントで参照されなければならない。
2. 通常テキストはコントラスト比4.5:1以上、UI要素は3:1以上を満たさなければならない。
3. 配色変更時、チャート配色は最大8系列まで自動調和（同一色相・彩度制御）しなければならない。
4. ダークモードが選択された場合、Surface/On-色は自動で反転し、意味色（成功/警告/エラー）は彩度を下げてまぶしさを抑えなければならない。

##### Requirment 12
**User Story:** アクセシビリティ配慮が必要な閲覧者として、キーボードと支援技術でレポートを利用したい。誰でも使えるようにするため。

###### Acceptance Criteria
1. フォーカスが移動した場合、操作対象境界を視覚的に明示しなければならない。
2. チャートのデータ点は表形式の代替表現を提供しなければならない。
3. 画面読み上げ時、カード・チャート・表のランドマークとラベルが論理順序で読み上げられなければならない。

#### Epic 5
共有・コラボレーション・配布

##### Requirment 13
**User Story:** オーナーとして、リンク共有と権限（閲覧/コメント/編集）を設定したい。安全に広めるため。

###### Acceptance Criteria
1. リンク共有が有効な場合、アクセスレベル（閲覧/コメント/編集）を必ず選択させなければならない。
2. 外部ドメインが含まれる共有では、期限付きトークンを自動付与し、有効期限を表示しなければならない。
3. 編集権限がないユーザーは、レイアウト変更やKPI設定を行ってはならない。

##### Requirment 14
**User Story:** チームとして、レポート上にコメントや注釈を残したい。解釈や背景を共有するため。

###### Acceptance Criteria
1. 注釈が追加された場合、対象要素・時点・作成者を記録しなければならない。
2. コメントスレッドは解決/再オープンの状態を持ち、解決済みは既定で折りたたまれなければならない。
3. エクスポート時、注釈の表示/非表示を選択できなければならない。

##### Requirment 15
**User Story:** 経営層として、定期的にレポートをメール/チャットで受け取りたい。閲覧の負担を減らすため。

###### Acceptance Criteria
1. 配信スケジュールが設定された場合、タイムゾーンと配信先を必須としなければならない。
2. 配信直前にデータを再取得し、対象スコープと取得時刻を本文に記載しなければならない。
3. 配信先が無効である場合、送信を行ってはならず、失敗理由を履歴に残さなければならない。

#### Epic 6
エクスポート・印刷・バージョン管理

##### Requirment 16
**User Story:** 利用者として、PDF/PNG/CSVへエクスポートしたい。社外配布や二次分析に使うため。

###### Acceptance Criteria
1. PDFエクスポート時、ヘッダーにレポート名・生成者・生成日時・データ更新時刻を含めなければならない。
2. PNGエクスポート時、各チャートは2倍解像度で生成しなければならない。
3. CSVエクスポート時、適用中のフィルター条件をメタ情報として先頭行に出力しなければならない。

##### Requirment 17
**User Story:** 利用者として、印刷レイアウトを事前に確認したい。紙面でも見やすくするため。

###### Acceptance Criteria
1. 印刷プレビューが開かれた場合、改ページ位置を視覚化しなければならない。
2. 余白設定を変更した場合、改ページ再計算を即時に行わなければならない。
3. 背景色の印刷を有効/無効で切り替えられなければならない。

##### Requirment 18
**User Story:** 作成者として、レポートのバージョン履歴を管理し以前の状態に戻したい。誤操作に備えるため。

###### Acceptance Criteria
1. 保存が行われた場合、差分（追加/更新/削除）と作成者・時刻を履歴に残さなければならない。
2. 任意の履歴にロールバックした場合、現在の状態は新規バージョンとして保存されなければならない。
3. 履歴の削除は管理者のみ実行できなければならない。

#### Epic 7
セキュリティ・権限・監査

##### Requirment 19
**User Story:** 管理者として、ロールごとにレポートの閲覧/コメント/編集/配信権限を制御したい。情報漏洩を防ぐため。

###### Acceptance Criteria
1. ロールが変更された場合、レポートごとの権限テーブルに即時反映されなければならない。
2. 配信権限のないユーザーは、配信スケジュールを作成・編集・有効化してはならない。
3. プライベートレポートは、オーナーと指名されたメンバー以外に表示してはならない。

##### Requirment 20
**User Story:** セキュリティ担当として、個人情報や機密値をマスキングしたい。不要な露出を避けるため。

###### Acceptance Criteria
1. マスキング対象フィールドが設定された場合、一覧・カード・エクスポート・配信の全経路で伏字を適用しなければならない。
2. マスキング解除は監査可能な操作として記録され、理由の入力が必須でなければならない。
3. 権限のないユーザーは、マスキング設定を変更してはならない。

##### Requirment 21
**User Story:** 監査人として、誰がいつ何を閲覧・変更・配信したかを追跡したい。コンプライアンスに対応するため。

###### Acceptance Criteria
1. レポートの閲覧が行われた場合、閲覧者・時刻・クライアントIPを記録しなければならない。
2. 変更や権限更新が行われた場合、旧値・新値・理由・実行者を記録しなければならない。
3. 監査ログのエクスポートは、管理者と監査人のみ許可されなければならない。

