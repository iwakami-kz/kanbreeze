# Requirements Document

## Introduction

本要件は、カンバンボードのカード／プロダクトバックログのアイテム／チケットリストのアイテムで共有される「チケット」の**詳細画面**を対象とする。チケットは「プロジェクトキー-採番（若い番号順）」のユニークIDを持ち、件名・説明・コメント・ステータス（カンバンレーンと同期）・担当者・ラベル・報告者・作成日・ファイル添付・他チケットとの関連・履歴表示を中核機能とする。UIは“親しみ感のある落ち着いた明るい色合い”を前提に、誰でも安心して読み書きできる体験とアクセシビリティを重視する。

## Requirments

#### Epic 1
**チケットの同一性と基本メタ情報（ID／件名／説明／作成日）**

##### Requirment 1
**User Story:** 「プロジェクトメンバーとして、作成した瞬間にユニークで読みやすいチケットIDが自動採番されてほしい。混乱なく参照できるから。」

###### Acceptance Criteria
1. チケット作成時、システムは `^[A-Z][A-Z0-9]+-[1-9][0-9]*$` 形式のID（例：`PRJ-1`）をプロジェクト単位の連番で自動採番しなければならない。
2. 採番は作成順に増加し、若い番号ほど古いチケットであることを保証しなければならない。
3. 欠番が生じた場合でも再利用してはならない。
4. IDは編集不可で、すべてのビュー（詳細／カンバン／バックログ／リスト）で同一表示でなければならない。
5. プロジェクト内でIDソート昇順は作成日の昇順と一致し、同一時刻の場合はIDの若番を優先しなければならない。

##### Requirment 2
**User Story:** 「チームメンバーとして、件名と説明を編集して内容を常に最新に保ちたい。関係者の理解を揃えるため。」

###### Acceptance Criteria
1. 件名は必須で、保存時に空欄ではならない。
2. 説明はMarkdown/プレーンテキストをサポートし、保存時にXSS対策を行わなければならない。
3. 変更は履歴に記録され、誰がいつ変更したかを表示しなければならない。
4. 件名・説明の編集は即時に他ビューへ反映されなければならない。

##### Requirment 3
**User Story:** 「閲覧者として、チケットの作成日を見たい。起票の文脈を理解するため。」

###### Acceptance Criteria
1. 作成日は保存され、詳細画面に表示されなければならない。
2. 時刻表示はプロジェクト既定タイムゾーン（例：Asia/Tokyo）で表示し、ホバーでISO8601の絶対時刻を表示しなければならない。
3. 一覧ビューでは相対時刻（例：3時間前）を表示し、詳細では絶対時刻への切替ができなければならない。

---

#### Epic 2
**ステータスとカンバンレーンの双方向同期**

##### Requirment 4
**User Story:** 「メンバーとして、詳細画面でステータスを変更するとカンバンのレーンも同期してほしい。進捗の二重管理を避けるため。」

###### Acceptance Criteria
1. 詳細画面でステータスを更新したとき、対応するカンバンレーンへリアルタイムに反映されなければならない。
2. ステータス—レーンの対応表はプロジェクト設定で管理され、未対応の組合せは選択できてはならない。
3. ステータス変更は履歴に「旧→新」「変更者」「時刻」として記録されなければならない。

##### Requirment 5
**User Story:** 「ボードユーザーとして、カードを別レーンにドラッグしたとき、詳細画面のステータスも一致してほしい。ビュー間で矛盾がないようにするため。」

###### Acceptance Criteria
1. レーン移動時、詳細画面のステータスは即時更新されなければならない。
2. 同時編集が発生した場合、後勝ちの更新でも履歴には両方のイベントが残らなければならない。
3. 不正なレーン（設定外）への移動は拒否され、ユーザーに理由が表示されなければならない。

##### Requirment 6
**User Story:** 「管理者として、ステータス遷移ルールを制御したい。品質ゲートを守るため。」

###### Acceptance Criteria
1. 設定で許可された遷移のみ実行でき、禁止遷移は実行してはならない。
2. 遷移時に必須フィールド（例：クローズ時の解決理由）が定義されている場合、未入力では保存してはならない。
3. 遷移ガードによりブロックされた場合、理由と必要アクションが表示されなければならない。

---

#### Epic 3
**担当者・報告者の管理**

##### Requirment 7
**User Story:** 「チームとして、担当者を設定・変更したい。責任の所在を明確にするため。」

###### Acceptance Criteria
1. 担当者は1名以上0名以上のいずれかをプロジェクト設定で許容できなければならない（デフォルト1名）。
2. 担当者変更は履歴に記録され、現在の担当者は詳細上部で視認できなければならない。
3. 担当者が未設定の場合、詳細画面に明示の未割当表示が出なければならない。

##### Requirment 8
**User Story:** 「起票者として、自分が報告者として自動で記録されてほしい。問い合わせ対応を追跡するため。」

###### Acceptance Criteria
1. 作成者は報告者として自動設定されなければならない。
2. 報告者は編集不可の既定とし、管理者のみ変更可能として設定できなければならない。
3. 報告者は詳細画面と履歴に常に表示されなければならない。

##### Requirment 9
**User Story:** 「担当者として、自分に関するチケットをすぐ見つけたい。作業を優先付けするため。」

###### Acceptance Criteria
1. 詳細画面から担当者名をクリックしたとき、同担当者のチケット一覧へ遷移できなければならない。
2. 担当者でフィルタしたURLは共有可能でなければならない。

---

#### Epic 4
**ラベル（キーワード）管理**

##### Requirment 10
**User Story:** 「メンバーとして、任意のキーワードを複数ラベルとして付与したい。検索性と分類のため。」

###### Acceptance Criteria
1. 1つのチケットに複数ラベルを追加・削除できなければならない。
2. ラベルはプロジェクト内で重複名を許してはならない。
3. ラベル変更は履歴に記録されなければならない。

##### Requirment 11
**User Story:** 「入力者として、既存ラベルを素早く選びたい。入力ミスを減らすため。」

###### Acceptance Criteria
1. ラベル入力欄はオートコンプリートを提供しなければならない。
2. 新規ラベル作成を許可している場合のみ、その場で作成できなければならない。
3. ラベル色の設定がある場合、コントラスト要件を満たさない配色は選択してはならない。

---

#### Epic 5
**コメント（複数）とコメント日時**

##### Requirment 12
**User Story:** 「関係者として、コメントを投稿したい。議論と決定事項を残すため。」

###### Acceptance Criteria
1. コメント投稿時、システムは投稿者・投稿日時を保存しなければならない。
2. コメントは作成日の昇順で表示され、最新コメントへジャンプできなければならない。
3. 送信後は即時に他ユーザーへ表示されなければならない。

##### Requirment 13
**User Story:** 「投稿者として、誤字を修正したい。内容の正確性を保つため。」

###### Acceptance Criteria
1. コメントは編集でき、編集時刻が表示されなければならない。
2. 編集前の内容は監査目的で保持され、通常UIでは表示してはならない。
3. コメント削除は投稿者と管理者のみ可能で、削除痕跡（削除者・時刻）を残さなければならない。

##### Requirment 14
**User Story:** 「読者として、日時表記を見やすく理解したい。時系列を追うため。」

###### Acceptance Criteria
1. コメントに絶対時刻（タイムゾーン付き）と相対時刻の双方を提供しなければならない。
2. タイムゾーンはプロジェクト既定に従い、ユーザー個別設定がある場合はそれを優先しなければならない。

---

#### Epic 6
**ファイル添付**

##### Requirment 15
**User Story:** 「メンバーとして、関連ファイルを添付したい。情報を一元管理するため。」

###### Acceptance Criteria
1. 添付はドラッグ＆ドロップとボタン選択の両方で追加できなければならない。
2. 追加時にファイル名・サイズ・アップロード者・アップロード日時を保存しなければならない。
3. アップロード完了前に画面を離れた場合、未完了の添付は保存してはならない。

##### Requirment 16
**User Story:** 「閲覧者として、添付を安全に参照したい。マルウェアを避けるため。」

###### Acceptance Criteria
1. 実行形式など危険拡張子はプレビュー不可とし、ダウンロード時に警告を表示しなければならない。
2. 画像・PDFはアプリ内プレビューを提供しなければならない。
3. 添付のアクセス権はチケットの閲覧権限に従わなければならない。

---

#### Epic 7
**他チケットとの関連付け**

##### Requirment 17
**User Story:** 「メンバーとして、チケット同士の関係を明示したい。影響範囲と依存関係を理解するため。」

###### Acceptance Criteria
1. 関連タイプとして少なくとも「関連する／重複／ブロックする／ブロックされている／親子」を選択できなければならない。
2. 関連付けは双方向リンクとして自動作成されなければならない。
3. 関連先が存在しないIDを登録してはならない。

##### Requirment 18
**User Story:** 「閲覧者として、関連チケットを素早く辿りたい。調査効率を上げるため。」

###### Acceptance Criteria
1. 関連一覧ではID・件名・ステータス・担当者を表示しなければならない。
2. クリックで関連チケット詳細へ遷移できなければならない。
3. ブロック関係が存在する場合、詳細上部に注意表示を出さなければならない。

---

#### Epic 8
**履歴表示（監査ログ）**

##### Requirment 19
**User Story:** 「管理者として、誰がいつ何を変えたかを追跡したい。説明責任のため。」

###### Acceptance Criteria
1. 履歴には少なくとも「変更者・時刻・項目・旧値・新値」を記録し表示しなければならない。
2. 履歴は変更の発生順に表示され、フィルタ（項目別）が可能でなければならない。
3. 履歴エントリは編集・削除できてはならない。

##### Requirment 20
**User Story:** 「レビュー担当として、説明の差分を把握したい。変更点を短時間で確認するため。」

###### Acceptance Criteria
1. 説明の変更は差分（追加・削除）表示を提供しなければならない。
2. 大きな変更の場合でも表示が崩れてはならない。

---

#### Epic 9
**UI/UX・配色・アクセシビリティ**

##### Requirment 21
**User Story:** 「全ユーザーとして、親しみ感のある落ち着いた明るい色合いで使いたい。心理的負荷を下げるため。」

###### Acceptance Criteria
1. カラートークン（例：`bg/surface`, `text/primary`, `accent/brand`, `state/success|warning|danger`）を定義し、全画面で一貫して使用しなければならない。
2. 背景は明度の高い柔らかいトーン、要素の境界は淡いシャドウまたはヘアラインで表現しなければならない。
3. 強調は原色の過飽和を避け、アクセントは限定された面積で使用しなければならない。

##### Requirment 22
**User Story:** 「アクセシビリティ配慮が必要な利用者として、読みやすいコントラストで利用したい。誰にとっても優しいUIのため。」

###### Acceptance Criteria
1. 本文テキストのコントラスト比は少なくとも4.5:1、ボタン等の大きなテキストは3:1を満たさなければならない。
2. 色のみに依存した状態表現をしてはならず、アイコン／ラベル／形状で補助しなければならない。
3. 主要操作はキーボードのみで完結でき、フォーカスインジケータが可視でなければならない。

##### Requirment 23
**User Story:** 「利用者として、どのビューから編集しても同じ体験で扱いたい。学習コストを下げるため。」

###### Acceptance Criteria
1. 詳細／カンバン／バックログ／リストで主要アクション（ステータス変更・担当者変更・ラベル付与）の配置と表現は一貫していなければならない。
2. いずれのビューからの更新も200ms以内に他ビューへ反映されなければならない（ネットワーク遅延を除くクライアント内反映）。

