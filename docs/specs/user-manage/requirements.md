# Requirements Document

## Introduction

本ドキュメントは、プロジェクト管理サービスにおける「ユーザー管理」機能の要件定義書である。対象ユーザーは「人（ヒューマンユーザー）」「API経由のLLM AI」「CLIコーディングエージェントツールAI」の3パターンを含む。親しみ感のある落ち着いた明るい色合いと、役割・安全性・監査可能性を両立した設計を目指す。

## Requirments

#### Epic 1 — 認証・ログイン

ヒューマンユーザーとAIエージェント（API/CLI）の安全で一貫した認証手段を提供する。

##### Requirment 1
**User Story:** ヒューマンユーザーとして、メール&パスワードでログインしたい。自分の作業スペースに安全にアクセスできるから。

###### Acceptance Criteria
1. ログイン要求が有効な資格情報である場合、システムはセッションを発行しなければならない。
2. ログイン失敗が5回連続した場合、システムはアカウントを一時ロックしなければならない。
3. ユーザーがMFAを有効にしている場合、システムはワンタイムコード検証を完了するまでアクセスを許可してはならない。
4. メール未検証の状態の間、システムはログイン後の機能利用を許可してはならない。

##### Requirment 2
**User Story:** 管理者として、SAML/OIDCによるSSOを設定したい。組織ポリシーに従って一括認証したいから。

###### Acceptance Criteria
1. SSOが有効化されている場合、システムは対象ドメインのユーザーに対しIdPによるリダイレクト認証を実施しなければならない。
2. SSO設定が保存されたとき、システムはメタデータの署名とエンドポイントの到達性を検証しなければならない。
3. SSO強制がオンの間、システムは対象ドメインのユーザーのパスワードログインを許可してはならない。
4. IdPの属性に役割マッピングが含まれる場合、システムは初回ログイン時にロールを自動付与しなければならない。

##### Requirment 3
**User Story:** API経由のLLM AIとして、APIキーで認証したい。人手を介さずに安全にタスクを呼び出したいから。

###### Acceptance Criteria
1. リクエストヘッダーに有効なAPIキーが含まれる場合、システムはキーのスコープと有効期限を検証しなければならない。
2. APIキーが失効している場合、システムは401を返し処理を実行してはならない。
3. キーが特定組織に紐づく場合、システムは他組織リソースへのアクセスを許可してはならない。
4. ローテーションが実行された場合、システムは旧キーを即時失効させなければならない。

##### Requirment 4
**User Story:** CLIコーディングエージェントツールAIとして、デバイスバインドされたトークンでログインしたい。開発環境から安全に操作できるから。

###### Acceptance Criteria
1. 初回認可フローが完了した場合、システムはデバイスIDと短期トークンを発行しなければならない。
2. デバイス指紋が変化した場合、システムは再認可を要求しなければならない。
3. トークン有効期限を超過した場合、システムは更新フロー以外でのアクセスを許可してはならない。
4. 組織がIP許可リストを設定している場合、システムは許可範囲外のアクセスを拒否しなければならない。

---

#### Epic 2 — ユーザー登録・招待・アクティベーション

新規作成から有効化までのライフサイクルを統一する。

##### Requirment 5
**User Story:** 管理者として、メールでメンバーを招待したい。スムーズにチームに参加させたいから。

###### Acceptance Criteria
1. 招待が送信された場合、システムは一意で期限付きの招待リンクを発行しなければならない。
2. 受邀者がリンクを開いた場合、システムはパスワード設定とプロフィール入力を求めなければならない。
3. 招待が期限切れの場合、システムは参加を許可してはならない。
4. 同一メールが既に所属している場合、システムは重複招待を作成してはならない。

##### Requirment 6
**User Story:** API経由のLLM AIとして、管理者の承認のもとでクライアントを登録したい。自動化を安全に導入したいから。

###### Acceptance Criteria
1. 登録申請が提出された場合、システムはクライアント名・用途・最小権限の申告を必須にしなければならない。
2. 管理者が承認した場合、システムはスコープ制限付きのクライアントID/シークレットを発行しなければならない。
3. 承認前の状態の間、システムはクライアントの実行を許可してはならない。
4. 用途が未記入の場合、システムは申請を保存してはならない。

##### Requirment 7
**User Story:** ヒューマンユーザーとして、パスワードを忘れたときにリセットしたい。すぐにアクセスを回復したいから。

###### Acceptance Criteria
1. リセット要求が正しいメールである場合、システムは使い切りのトークンを送信しなければならない。
2. トークンが使用済みである場合、システムは再利用を許可してはならない。
3. トークンが有効期限内かつ多要素利用組織である場合、システムはMFA再検証を要求しなければならない。
4. リセット完了後、システムは全セッションを無効化しなければならない。

---

#### Epic 3 — 役割・権限（RBAC/ABAC）

最小権限での安全な操作を保証する。

##### Requirment 8
**User Story:** 管理者として、ロール（オーナー/管理者/メンバー/閲覧者）を割り当てたい。不要な権限を避けたいから。

###### Acceptance Criteria
1. ロールが変更された場合、システムは新ロールに基づき即時に権限を再評価しなければならない。
2. ロール未割当のユーザーに対し、システムはデフォルトで閲覧者権限のみを付与しなければならない。
3. ユーザーが自分のロールを昇格させる操作を実行した場合、システムは拒否しなければならない。
4. 監査イベントとして、ロール変更の履歴を保存しなければならない。

##### Requirment 9
**User Story:** API経由のLLM AIとして、タスク作成とコメントのみ許可されたスコープで実行したい。過剰な権限を避けたいから。

###### Acceptance Criteria
1. リクエストの署名が検証された場合、システムはスコープに合致するエンドポイントのみを許可しなければならない。
2. スコープ外の操作が要求された場合、システムは403を返しなければならない。
3. スコープが複数付与されている場合、システムは最小権限の原則で評価しなければならない。
4. スコープが更新されたとき、システムは次回リクエストから即時反映しなければならない。

##### Requirment 10
**User Story:** CLIコーディングエージェントツールAIとして、特定プロジェクトに限定された権限でリポジトリアクセスしたい。誤操作を防ぎたいから。

###### Acceptance Criteria
1. 対象プロジェクトが指定されている場合、システムは他プロジェクトの操作を許可してはならない。
2. 認可ポリシーが「レビュー必須」の場合、システムは人間の承認イベントを待機しなければならない。
3. レビューが拒否された場合、システムは当該操作をロールバックしなければならない。
4. ポリシー変更の間、システムは保留中操作の評価を再実行しなければならない。

---

#### Epic 4 — 組織・チーム管理

マルチテナントの組織階層とチーム単位の管理を提供する。

##### Requirment 11
**User Story:** 組織管理者として、組織配下にチームを作成したい。権限と可視性を分離したいから。

###### Acceptance Criteria
1. チームが作成された場合、システムは一意のIDと表示名を割り当てなければならない。
2. チーム可視性が「公開」の場合、組織内ユーザーはディレクトリ検索で発見できなければならない。
3. チーム可視性が「非公開」の場合、メンバー以外は検索結果に表示してはならない。
4. チーム削除時、システムは所属ユーザーの参照整合性を保つために再割当またはアーカイブを要求しなければならない。

##### Requirment 12
**User Story:** ヒューマンユーザーとして、複数組織を切り替えたい。案件ごとに環境を分けたいから。

###### Acceptance Criteria
1. 組織スイッチが実行された場合、システムはナビゲーションと権限コンテキストを即時切替しなければならない。
2. 直前に使用した組織が存在する場合、システムは次回ログイン時にその組織を既定選択しなければならない。
3. アクセス権が失効している組織は、選択肢として表示してはならない。
4. 切替イベントは監査ログに記録されなければならない。

##### Requirment 13
**User Story:** 管理者として、SCIM/CSVでメンバーを一括プロビジョニングしたい。大規模導入を効率化したいから。

###### Acceptance Criteria
1. ディレクトリ連携が有効な場合、システムは属性マッピングに従いユーザーを作成しなければならない。
2. 入力に重複メールがある場合、システムは重複行を拒否し詳細をレポートしなければならない。
3. 無効化フラグが付いたレコードについて、システムは該当ユーザーを停止しなければならない。
4. プロビジョニング結果はダウンロード可能な監査レポートとして提供しなければならない。

---

#### Epic 5 — プロフィール・ディレクトリ・検索

見つけやすさと自己紹介の管理。

##### Requirment 14
**User Story:** ヒューマンユーザーとして、自分のプロフィール（氏名、肩書、アイコン、所属）を編集したい。コラボしやすくするため。

###### Acceptance Criteria
1. 入力が保存された場合、システムは即時にディレクトリへ反映しなければならない。
2. 必須項目が欠落している場合、システムは保存を完了してはならない。
3. 不適切な画像形式がアップロードされた場合、システムは拒否しなければならない。
4. 変更履歴は30日間保持し、ロールバックできなければならない。

##### Requirment 15
**User Story:** API経由のLLM AIとして、実行主体の表示名と用途説明を設定したい。監査と可視性のため。

###### Acceptance Criteria
1. 表示名が設定された場合、システムは操作ログに当該名を表示しなければならない。
2. 用途説明が未設定の状態の間、システムは組織既定の警告バナーを表示しなければならない。
3. 表示名が組織内で一意でない場合、システムは登録を完了してはならない。
4. 説明が更新されたとき、システムは次の実行から表示を更新しなければならない。

##### Requirment 16
**User Story:** すべてのユーザータイプとして、属性でメンバーを検索したい。該当担当者/エージェントを素早く見つけたいから。

###### Acceptance Criteria
1. 検索が実行された場合、システムは名前・メール・ロール・チーム・主体タイプでフィルターできなければならない。
2. 非公開チーム所属のみのユーザーは、権限のない検索者に対して結果に表示してはならない。
3. 検索結果は100ms以内の反応を目標とし、1,000件を超える場合システムはページングしなければならない。
4. 検索条件はURLとして共有可能でなければならない。

---

#### Epic 6 — AIエージェント管理（API LLM / CLIツール）

エージェントの登録、スコープ、レート制御、ヒューマン・イン・ザ・ループを提供する。

##### Requirment 17
**User Story:** 管理者として、エージェントごとに最小権限のスコープを設定したい。誤用を防ぎたいから。

###### Acceptance Criteria
1. スコープ更新が保存された場合、システムは次回リクエストから強制しなければならない。
2. スコープに「書込」が含まれない場合、システムは作成・更新系エンドポイントを許可してはならない。
3. 変更は監査ログに旧値・新値を記録しなければならない。
4. スコープが存在しない場合、システムはデフォルトで読み取り専用に制限しなければならない。

##### Requirment 18
**User Story:** 組織管理者として、エージェントの実行にレビュー承認を要求したい。重要操作を人が確認するため。

###### Acceptance Criteria
1. 対象操作が「レビュー必須」の場合、システムは人間承認が完了するまで実行してはならない。
2. 承認がタイムアウトした場合、システムは操作を中止し依頼者へ通知しなければならない。
3. 承認者が差戻しコメントを入力した場合、システムは当該コメントをエージェントへ返却しなければならない。
4. 緊急時フラグが有効かつ権限がオーナーである場合、システムはバイパス実行と後追いレビューを記録しなければならない。

##### Requirment 19
**User Story:** SREとして、エージェントごとにレート制限と並列数を設定したい。安定稼働を守るため。

###### Acceptance Criteria
1. 1秒あたり/1分あたりの上限が超過した場合、システムは429を返しリトライ指示を含めなければならない。
2. 並列数が上限に達している間、システムは新規実行のキューイングまたは拒否を行わなければならない。
3. 組織が上書きポリシーを設定している場合、システムは組織値を優先しなければならない。
4. 制限値変更は即時反映され、メトリクスに可視化されなければならない。

##### Requirment 20
**User Story:** セキュリティ担当として、エージェントのネットワーク許可先を制限したい。データ流出を防ぐため。

###### Acceptance Criteria
1. 許可リスト外の外部ドメインへの接続要求が発生した場合、システムはブロックしなければならない。
2. 許可リストが空である間、システムは外部通信を許可してはならない。
3. 設定変更が保存された場合、システムは影響エージェントを一覧表示しなければならない。
4. ブロックイベントはセキュリティ監査に記録されなければならない。

---

#### Epic 7 — セキュリティポリシー・コンプライアンス

MFA、パスワード、セッション、データ保持を統一管理する。

##### Requirment 21
**User Story:** 組織管理者として、MFA必須ポリシーを有効化したい。不正アクセスを減らすため。

###### Acceptance Criteria
1. ポリシーが有効な場合、システムは未設定ユーザーにMFAセットアップを強制しなければならない。
2. 管理者権限を持つユーザーは、MFA未設定の状態で管理操作を実行してはならない。
3. リカバリーコードが発行された場合、システムは一度に10件まで生成し再表示してはならない。
4. MFAデバイスの削除が要求された場合、システムは本人再認証を要求しなければならない。

##### Requirment 22
**User Story:** セキュリティ担当として、セッション有効期限とアイドルタイムアウトを設定したい。端末放置リスクを減らすため。

###### Acceptance Criteria
1. セッションが最大寿命を超過した場合、システムは再ログインを要求しなければならない。
2. アイドル時間が閾値を超過した場合、システムは自動ログアウトしなければならない。
3. 高度権限セッションの間、システムは短い有効期限を適用しなければならない。
4. 再開時、システムは保存されていない作業内容の損失を防ぐため復元オプションを提示しなければならない。

##### Requirment 23
**User Story:** コンプライアンス担当として、アカウント削除とデータ保持期間を管理したい。規制に準拠するため。

###### Acceptance Criteria
1. 削除要求が確定した場合、システムは法定保持期間を考慮したスケジュール削除を設定しなければならない。
2. 保持期間中であっても、システムは個人識別子を疑似匿名化しなければならない。
3. 法的ホールドが有効な間、システムは当該データの削除を実行してはならない。
4. 完了後、システムは削除証明のレポートを生成しなければならない。

---

#### Epic 8 — 監査・可観測性

すべての重要操作に対する追跡と可視化。

##### Requirment 24
**User Story:** 監査担当として、誰がいつ何をしたかをタイムラインで見たい。問題追跡に必要だから。

###### Acceptance Criteria
1. 重要操作が発生した場合、システムは主体（人/LLM/CLI）・対象・結果・メタ情報を記録しなければならない。
2. 監査ログはフィルター（日時、主体タイプ、ユーザー、リソース、結果）で検索可能でなければならない。
3. ログ改ざんの痕跡が検知された場合、システムは改ざん防止ストレージから検証し警告しなければならない。
4. エクスポート要求時、システムはCSV/JSONでダウンロードを提供しなければならない。

##### Requirment 25
**User Story:** 管理者として、エージェントの操作をヒューマンフレンドリーに可視化したい。レビュー負荷を下げたいから。

###### Acceptance Criteria
1. エージェント主体のログには、表示名・用途・スコープが含まれていなければならない。
2. 連続した操作が同一トランザクションに属する場合、システムはスレッド表示をしなければならない。
3. 危険度が高い操作は、システムがハイライトしなければならない。
4. 監査ビューのアクセスはRBACで制御されなければならない。

---

#### Epic 9 — UI/UXテーマ & アクセシビリティ

親しみ感のある落ち着いた明るい色合い、かつ誰もが使いやすいUIを提供する。

##### Requirment 26
**User Story:** ヒューマンユーザーとして、落ち着いた明るい配色でユーザー管理画面を使いたい。集中しやすく疲れにくいから。

###### Acceptance Criteria
1. 既定テーマはライト基調で、背景は低彩度・高明度、アクセントは中彩度・中明度でなければならない。
2. 主要UI要素のコントラスト比はWCAG AAを満たさなければならない。
3. ユーザーの好みで淡色/濃色コントラストを切り替え可能でなければならない。
4. 危険操作（削除/権限剥奪）は、明度差とアイコンで視覚的に区別されなければならない。

##### Requirment 27
**User Story:** アクセシビリティ利用者として、キーボード操作とスクリーンリーダーで全機能を使いたい。誰でも利用できるようにするため。

###### Acceptance Criteria
1. すべての操作はTab/Shift+Tabで到達でき、フォーカスリングが常に見えるようでなければならない。
2. 画像・アイコンには代替テキストが提供されなければならない。
3. ライブ通知が発生した場合、システムはARIAライブリージョンで告知しなければならない。
4. エラーメッセージはテキストと記号の両方で提示されなければならない。

##### Requirment 28
**User Story:** 管理者として、ブランドに合わせてテーマトークンをカスタマイズしたい。組織の一体感を出すため。

###### Acceptance Criteria
1. カラートークン（primary/secondary/success/warning/danger/neutral）が設定可能でなければならない。
2. トークン更新時、システムはUI全体に即時反映しなければならない。
3. コントラストが基準を下回る設定が保存される場合、システムは警告して保存を拒否しなければならない。
4. テーマはエクスポート/インポート可能でなければならない。

---

#### Epic 10 — 通知・連絡・連携

メール・Slack・Webhookなどでアカウント関連イベントを通知する。

##### Requirment 29
**User Story:** 管理者として、重要なユーザーイベント（招待、ロール変更、無効化）をSlackで受け取りたい。対応を迅速化するため。

###### Acceptance Criteria
1. Webhook URLが設定されている場合、システムはイベント発生時にペイロードを送信しなければならない。
2. 送信に失敗した場合、システムは指数バックオフで再試行しなければならない。
3. ペイロードには主体タイプ（人/LLM/CLI）が含まれていなければならない。
4. 通知の種類はイベントごとにオン/オフ設定できなければならない。

##### Requirment 30
**User Story:** ユーザーとして、自分のアカウントに重要変更が行われたときにメールで通知されたい。身に覚えのない変更を検知するため。

###### Acceptance Criteria
1. パスワード変更・MFA変更・ログイン新端末が発生した場合、システムは即時にメール通知しなければならない。
2. 通知には変更内容の概要と異常時の対処リンクが含まれていなければならない。
3. メール送信が抑止設定されている間でも、セキュリティ関連通知は抑止してはならない。
4. メールの言語はユーザープロフィールの言語設定に従わなければならない。

---

#### Epic 11 — 休止・無効化・削除（ライフサイクル）

アカウントやエージェントの状態管理と復帰。

##### Requirment 31
**User Story:** 管理者として、ユーザーまたはエージェントを一時停止したい。調査の間リスクを抑えるため。

###### Acceptance Criteria
1. 状態が「停止中」の間、システムは新規ログイン・API実行を許可してはならない。
2. 停止理由が記録されていない場合、システムは停止操作を完了してはならない。
3. 復帰が行われた場合、システムは監査ログに復帰者と時刻を記録しなければならない。
4. 停止中でも、データ保持・監査ログの参照は許可されなければならない。

##### Requirment 32
**User Story:** 管理者として、退職者のアカウントを安全に削除したい。情報漏洩を防ぐため。

###### Acceptance Criteria
1. 削除前に所有リソースが存在する場合、システムは再割当またはアーカイブを完了するまで削除してはならない。
2. 削除が完了した場合、システムは関連トークンとセッションを失効させなければならない。
3. 削除は遅延実行期間を設け、その間は復元可能でなければならない。
4. 削除実行者はオーナーまたは委任された管理者でなければならない。

---

#### Epic 12 — 設定・自己サービス

各主体が自分に関する設定を管理できる。

##### Requirment 33
**User Story:** ヒューマンユーザーとして、MFAやセキュリティ設定を自分で管理したい。迅速に保護を強化したいから。

###### Acceptance Criteria
1. 追加されたMFAデバイスはラベル付けされ、既定デバイスを選択できなければならない。
2. 予備メール/電話の検証が未完了の間、リカバリー先として選択してはならない。
3. セキュリティログは直近30日のサインイン履歴を表示しなければならない。
4. 自己削除の要求は二段階確認を経なければならない。

##### Requirment 34
**User Story:** エージェント管理者として、APIキーのローテーションを計画的に行いたい。停止なく運用したいから。

###### Acceptance Criteria
1. 新旧キーの重複有効期間を設定でき、期間終了後は旧キーを自動失効しなければならない。
2. 期限が近い場合、システムは通知を送らなければならない。
3. ローテーション計画は監査ログに記録されなければならない。
4. 期限切れのキーが存在する間、システムは利用を拒否しなければならない。

---

#### Epic 13 — 国際化・ローカリゼーション

多言語・タイムゾーン・表記を統一管理する。

##### Requirment 35
**User Story:** グローバルチームのユーザーとして、言語とタイムゾーンを個別に設定したい。正しい表記で確認したいから。

###### Acceptance Criteria
1. 言語設定が保存された場合、システムはUIと通知の言語を即時切替しなければならない。
2. タイムゾーンに基づき、ログと通知の時刻はユーザーのローカル表示でなければならない。
3. 未設定の間、システムは組織既定の言語とタイムゾーンを適用しなければならない。
4. 日付・数値・名前の表記はロケールに従って整形されなければならない。

