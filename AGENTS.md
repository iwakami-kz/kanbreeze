# AGETNS.md — エージェント運用ガイド（kanbreeze）

この文書は、**人間**・**LLM/APIエージェント**・**CLIコーディングエージェント**・**CI/Bot**が同一リポジトリで安全かつ生産的に協働するためのルールをまとめたものです。  

## 目的
- ローカル実行前提の開発体験を壊さずに、エージェントの自動化を取り入れる
- セキュリティ・法令・品質（コミット規約/レビュー）を**人と同等**に担保する
- 変更の**再現可能性**・**追跡可能性**を保つ

## 1. ロール定義
- **Human（人間）**: コードの最終責任者。レビュー/承認/設計判断を行う。
- **LLM/API Agent（AI）**: 仕様化・リファクタ・テスト生成・ドキュメント整備などの支援を行う。外部ツールへの呼び出しは**許可リスト**方式。
- **CLI Coding Agent**: ローカルでコードを生成/変更する自動化スクリプト。`git` 操作は**専用トークン**で実施。
- **CI/Bot**: Lint/Test/ビルド/セキュリティ検査等を実行。Actionsの権限は最小化する。

> メール/ユーザー名の例  
> - Human: `You <you@example.com>`  
> - Agent: `kanbreeze-agent <bot@your-domain>`  
> - CI: `kanbreeze-ci <ci@your-domain>`

## 2. コミット／タグ規約
- **Conventional Commits** に準拠（例：`feat: WIP制限を列ごとに導入`、`fix(auth): OIDCリフレッシュ不具合`、`docs: AGENTSガイド追記`）。**破壊的変更**は `BREAKING CHANGE:` で明示。
- リリースは **SemVer**（`MAJOR.MINOR.PATCH`）。自動生成のCHANGELOGと相性が良い。
- 可能なら **DCO**（`Signed-off-by:`）を採用。法的に寄与者が権利を有する旨の表明。

**コミット例（エージェント実行時）**
```
feat(board): WIP制限を列ごとに導入

- set_wip_limit(column_id, limit) を追加
- 既存の移動ルールを更新して検証を強化
- docs: ボード設定ガイドにWIP追記

Signed-off-by: kanbreeze-agent <bot@your-domain>
```

## 3. ブランチ運用／レビュー
- `main` は **Protected Branch**。PR経由のみ、**レビュー1件以上**と**ステータスチェック成功**を必須化。
- マージ方法は **Squash** を既定（履歴を簡潔に保つ）。必要に応じて Rebase/Merge Commit を許可。
- ブランチ命名：`feature/<要約>`、`fix/<issue#>`、`docs/<topic>` 等。

**PR テンプレ（要旨）**
- 目的／背景
- 変更点（箇条書き）
- 動作確認（手順・スクショ）
- 影響範囲／移行
- 関連Issue（`Close #123`）

## 4. セキュリティ・秘密情報の扱い
- **秘密情報はコミット禁止**。APIキー/トークンは環境変数やローカル秘密管理（例：`.env.local`）に保持。  
- **Secret scanning** を有効化し、漏えいを自動検知。プッシュ保護も利用可。
- **GitHub Actionsのセキュリティ強化**  
  - Actionの**バージョンピン**（SHA or 固定タグ）  
  - `permissions:` を**最小権限**に設定  
  - サードパーティActionの採用は慎重に（レビュー/トラスト）  
  - 長期トークンの使用は避け、可能な限り**短命/限定的な認証**方式を利用  
  （セキュアなワークフロー作成のベストプラクティス参照）

## 5. LLM/エージェント特有のリスクと対策
- **プロンプトインジェクション**／**不適切な出力取り扱い**／**サプライチェーン脆弱性** など、LLM特有のリスクに留意。対策として**入力検証・出力サニタイズ・ツール呼び出しの許可リスト**・**オフライン評価**を徹底。
- 生成コードは**自動で実行しない**。エージェントが提案したスクリプトは**人間レビュー**と**サンドボックス**で検証。
- エージェントの外部アクセス（HTTP/DB/FS）は**明示的に許可**された範囲に限定（`ALLOWLIST.md` を別途管理）。

## 6. エージェント実行ポリシー（ローカル）
- **実行モード**  
  - `read`: 解析のみ（ファイル/テスト/ログを読む）。  
  - `plan`: 変更計画とパッチ案を提示（**PR下書き**を生成）。  
  - `apply`: 小規模変更を直接コミット（保護ブランチ以外）。  
- **I/O規律**  
  - 生成物の**差分は最小**に（無関係な整形・並び替えを避ける）。  
  - ファイル作成/削除は**理由**をコミットメッセージに明記。  
  - ライセンスや著作権表示は保持（SPDXヘッダがある場合は踏襲）。
- **テレメトリ**  
  - ローカルでは OpenTelemetry で**最小限の匿名メトリクス**を収集（実行時間/失敗率など）。個人情報や秘密は送信しない。

## 7. エージェント用プロンプト（最小セット）

> `prompt/agent_system.txt`（例）

```
あなたは kanbreeze のリポジトリで作業するコーディングエージェントです。
必ず次を守ってください：
- 破壊的変更は提案段階（plan）に留め、applyしない
- 秘密情報（キー/トークン）を書かない・読み込まない
- 生成コードは冪等で再現可能に。副作用のある処理は明示し、実行しない
- Conventional Commitsでコミットメッセージを書く
- 変更点・理由・影響をPRの要約に記述
- LLMセキュリティ（プロンプトインジェクション/出力の無検証実行禁止）を遵守
```

## 8. 変更の受け入れ基準（エージェント由来のPR）
- [ ] **テスト**が追加・更新されている（失敗時の再現手順が明記）
- [ ] **Conventional Commits** に準拠（`type(scope): summary`）
- [ ] 影響範囲・移行手順・ロールバック手順が PR に記載
- [ ] サードパーティ依存の追加は理由・バージョン固定・代替案を明記
- [ ] 生成コードの**静的解析/Lint/フォーマット**が通過
- [ ] **Secret scanning** に引っかからないことを確認（CIでも検査）
- [ ] セキュリティ上の考慮（OWASP LLM Top 10の該当項目）が明記

## 9. 失敗時の扱い
- バイナリや大規模ファイルの誤コミット→**即時Revert**＋`.gitignore` 追加。  
- 秘密情報の漏えいを検知→該当キーの**無効化/ローテーション**・影響調査・再発防止策をIssue化。**Secret scanning** の検出ログを参照。
- 依存関係のサプライチェーン問題→該当依存の**ピン止め/置換**・Advisoryリンク共有・再デプロイ。

## 10. Bot / CI のベストプラクティス（抜粋）
- **最小権限**のトークン/権限設定（`GITHUB_TOKEN` の `permissions:` を必要最小に）。
- Actionは**特定バージョン**（SHA）で固定。
- 可能な限り**短命・限定的な認証**方式を使用（長期トークンの常用回避）。
- セキュリティ検査（CodeQL/依存監査/シークレット検査）をPRに組み込み。

